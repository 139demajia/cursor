name: CI

on:
    pull_request:
        branches:
            - '*'
    push:
        branches:
            - main

defaults:
    run:
        shell: bash

jobs:
    all:
        name: All

        strategy:
            matrix:
                os:
                    - macos-latest
                    - ubuntu-latest
                    - windows-latest

        runs-on: ${{matrix.os}}

        steps:
            - uses: actions/checkout@v2

            - name: Setup macOS/linux
              if: ${{ matrix.os == 'macos-latest' || matrix.os == 'ubuntu-latest' }}
              run: ./setup.sh

            - name: Setup windows
              if: ${{ matrix.os == 'windows-latest' }}
              shell: pwsh
              run: ./setup.ps1

            - name: Install required linux packages
              if: ${{ matrix.os == 'ubuntu-latest' }}
              run: sudo apt-get update && sudo apt-get install -y dpkg fakeroot tree

            - name: Install dependencies
              run: npm ci

            - name: Check formatting
              run: npm run format-check

            - name: Build
              run: npm run make

            - name: Publish macOS artifacts
              if: matrix.os == 'macos-latest'
              uses: actions/upload-artifact@v2
              with:
                  name: macos-artifact
                  path: |
                      out/make/zip/darwin/x64/*.zip

            - name: Publish Linux artifacts
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v2
              with:
                  name: linux-artifact
                  path: |
                      out/make/deb/x64/*.deb

            - name: Publish Windows artifacts
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v2
              with:
                  name: windows-artifact
                  path: |
                      out/make/zip/windows/x64/*.zip
